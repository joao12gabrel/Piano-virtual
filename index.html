<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    <title>VirtuPiano STUDIO FINAL</title>
    <style>
        :root {
            --bg-color: #08080a;
            --bg-grad: radial-gradient(circle at center, #1a1a24 0%, #000000 100%);
            --glass: rgba(30, 30, 35, 0.95);
            --border: rgba(255, 255, 255, 0.15);
            --accent: #00e5ff;
            --rec-color: #ff2a6d;
            --text-main: #ffffff;
            --key-gap: 2px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-color); background-image: var(--bg-grad);
            height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; color: var(--text-main); touch-action: none;
        }

        /* --- TELA DE BOAS VINDAS (Responsiva e Centralizada) --- */
        #splashScreen {
            position: fixed; top: 0; left: 0; 
            width: 100vw; height: 100dvh; /* Garante altura total no mobile */
            background: radial-gradient(circle, #1a1a20 0%, #000000 100%);
            z-index: 9999;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; /* Centro Absoluto */
            padding: 20px;
            transition: opacity 0.5s ease;
        }
        .splash-content { 
            text-align: center; 
            animation: fadeIn 1s ease;
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 400px; /* Limite para PC */
        }
        .splash-logo { font-size: 4rem; margin-bottom: 10px; text-shadow: 0 0 30px var(--accent); }
        .splash-title { 
            font-size: 2rem; font-weight: 800; color: white; 
            letter-spacing: 2px; margin-bottom: 40px; 
        }
        .splash-title span { color: var(--accent); }
        
        .btn-start {
            background: linear-gradient(90deg, var(--accent), #00ff88);
            border: none; padding: 18px 50px; border-radius: 50px;
            color: #000; font-weight: 900; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
            width: 100%; max-width: 280px; /* Bot√£o bonito no mobile e PC */
        }
        .btn-start:hover { transform: scale(1.05); box-shadow: 0 0 35px rgba(0, 229, 255, 0.7); }
        .btn-start:active { transform: scale(0.95); }
        
        .splash-footer {
            color: #555; margin-top: 30px; font-size: 0.8rem;
            max-width: 300px; line-height: 1.4;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* UI GERAL */
        .icon-btn { border: none; background: none; color: #aaa; font-size: 1.2rem; cursor: pointer; padding: 5px; transition: color 0.2s; }
        .icon-btn:hover { color: #fff; }

        /* TOASTS */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 4000; pointer-events: none; width: 90%; max-width: 300px; display: flex; flex-direction: column; align-items: center; }
        .toast { background: rgba(20,20,25,0.95); border-left: 3px solid var(--accent); color: #fff; padding: 12px 20px; border-radius: 4px; font-size: 0.9rem; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.8); animation: popIn 0.2s forwards; margin-bottom: 5px; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* HEADER */
        .app-header { flex: 0 0 auto; width: 100%; background: var(--glass); border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; gap: 10px; z-index: 50; backdrop-filter: blur(10px); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .logo { font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: 1px; }
        .logo span { color: var(--accent); }

        .controls-wrapper { display: flex; justify-content: center; width: 100%; }
        .controls-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; max-width: 600px; }
        .music-row { display: flex; gap: 8px; max-width: 600px; margin: 0 auto; width: 100%; align-items: center; }
        select { flex: 1; height: 36px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #ddd; border-radius: 6px; padding: 0 10px; font-size: 0.85rem; outline: none; }
        
        button { height: 48px; border: 1px solid var(--border); border-radius: 8px; background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.15s ease; }
        button:active { transform: scale(0.96); background: rgba(255,255,255,0.1); }
        button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .btn-icon { font-size: 1.2rem; margin-bottom: 3px; }
        .btn-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; opacity: 0.7; }

        .btn-play.active { border-color: var(--accent); background: rgba(0, 229, 255, 0.15); color: var(--accent); }
        .btn-rec.active { border-color: var(--rec-color); background: rgba(255, 42, 109, 0.15); color: var(--rec-color); animation: pulse 1.5s infinite; }
        .btn-metro.active { border-color: #ffcc00; color: #ffcc00; }
        .btn-pedal.active { border-color: #00ff88; color: #00ff88; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* VISUALIZADOR & PIANO */
        .visualizer-area { flex: 1; position: relative; width: 100%; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(180deg, #050505 0%, #111 100%); }
        #gameCanvas { width: 100%; height: 100%; position: absolute; bottom: 0; left: 0; opacity: 0.8; }
        .octave-ctrl { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; align-items: center; z-index: 100; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border); }
        .oct-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #555; background: #222; color: #fff; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .oct-display { font-size: 0.8rem; font-weight: bold; color: #aaa; width: 70px; text-align: center; }
        
        .piano-container { flex: 0 0 auto; width: 100%; height: 32vh; min-height: 160px; max-height: 300px; background: #111; border-top: 4px solid #222; position: relative; z-index: 60; padding: 5px; padding-bottom: calc(5px + env(safe-area-inset-bottom)); box-shadow: 0 -10px 40px rgba(0,0,0,0.8); }
        .keys-wrapper { display: flex; height: 100%; position: relative; gap: var(--key-gap); }
        .key { position: relative; cursor: pointer; border-radius: 0 0 6px 6px; touch-action: none; flex: 1; }
        .key.white { background: linear-gradient(180deg, #ffffff 0%, #e8e8e8 85%, #d1d1d1 100%); }
        .key.white.active { transform: scaleY(0.96); transform-origin: top; background: #ccc; }
        .key.black { position: absolute; top: 0; width: 6.5%; height: 60%; background: linear-gradient(180deg, #333 0%, #000 100%); z-index: 10; border-radius: 0 0 4px 4px; }
        .key.black.active { background: #222; transform: scaleY(0.96); transform-origin: top; box-shadow: 0 0 15px var(--accent); border-bottom: 2px solid var(--accent); }
        .key-label { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: #888; pointer-events: none; }

        /* MODALS & DIALOGS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box { background: #15151a; width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 0 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #202028; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }

        .dialog-input { width: 100%; height: 40px; background: #000; border: 1px solid #444; color: white; padding: 0 10px; border-radius: 5px; margin-bottom: 15px; outline: none; }
        .dialog-input:focus { border-color: var(--accent); }
        .dialog-btns { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-dialog { padding: 0 20px; height: 40px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #333; color: white; }
        .btn-confirm { background: var(--accent); color: black; }
        .btn-danger { background: var(--rec-color); color: white; }

        /* DJ STUDIO */
        .sequencer-panel { background: linear-gradient(135deg, #101015, #000); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center; }
        .sequencer-title { color: var(--accent); font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
        .sequencer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-preview { background: #333; color: white; border: 1px solid #555; height: 40px; border-radius: 6px; }
        .btn-render { background: var(--rec-color); color: white; border: none; height: 40px; border-radius: 6px; }
        
        .dj-grid { display: grid; gap: 15px; margin-bottom: 15px; }
        .deck { background: #0f0f13; padding: 12px; border-radius: 8px; border: 1px solid #333; position: relative; transition: border-color 0.2s; }
        .deck.playing { border-color: var(--accent); box-shadow: 0 0 15px rgba(0,229,255,0.15); }
        .btn-close-deck { position: absolute; top: 5px; right: 5px; width: 25px; height: 25px; background: #ff0055; color: white; border: none; border-radius: 50%; font-size: 0.9rem; cursor: pointer; z-index: 10; display:flex; align-items:center; justify-content:center; }
        .deck-top { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .vinyl { width: 50px; height: 50px; min-width: 50px; border-radius: 50%; background: conic-gradient(#111 0% 25%, #333 25% 50%, #111 50% 100%); border: 2px solid #555; }
        .vinyl.spinning { animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .eq-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .eq-col { display: flex; flex-direction: column; align-items: center; height: 100px; justify-content: center; }
        .slider-wrapper { width: 30px; height: 80px; display: flex; align-items: center; justify-content: center; }
        .slider-v { width: 80px; height: 4px; transform: rotate(-90deg); background: #333; outline: none; -webkit-appearance: none; border-radius: 2px; cursor: pointer; }
        .slider-v::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .deck-bottom { display: grid; gap: 8px; }
        .slider-group { display: flex; flex-direction: column; gap: 2px; }
        .slider-group label { font-size: 0.6rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .slider-group input[type=range] { width: 100%; height: 4px; border-radius: 2px; accent-color: var(--accent); }
        .btn-add-deck { width: 100%; height: 40px; background: #00ff88; color: #000; border: none; border-radius: 8px; font-weight: bold; }

        .help-section { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .help-section h4 { color: var(--accent); margin-bottom: 8px; }
        .help-section p { font-size: 0.9rem; color: #ccc; margin-bottom: 5px; }
        .help-section ul { list-style: none; padding-left: 10px; }
        .help-section li { font-size: 0.85rem; color: #aaa; margin-bottom: 4px; }

        @media (min-width: 768px) {
            .app-header { padding: 15px 30px; }
            .piano-container { height: 40vh; max-height: 400px; padding: 10px; }
            .controls-grid { grid-template-columns: repeat(5, 1fr); gap: 15px; }
            .dj-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- TELA DE BOAS VINDAS -->
    <div id="splashScreen">
        <div class="splash-content">
            <div class="splash-logo">üéπ</div>
            <div class="splash-title">VirtuPiano <span>STUDIO</span></div>
            <button class="btn-start" onclick="startApp()">COME√áAR</button>
            <div class="splash-footer">Seus dados e m√∫sicas ficam salvos apenas neste dispositivo.</div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="app-header">
        <div class="top-bar">
            <div class="logo"><span style="font-size:1.4rem">üéπ</span> VirtuPiano <span>STUDIO</span></div>
            <button class="icon-btn" onclick="UISys.openModal('helpModal')">‚ùì</button>
        </div>

        <div class="music-row">
            <select id="songSelect" onchange="UISys.checkButtons()">
                <option value="">-- Selecione uma Grava√ß√£o --</option>
                <optgroup label="Minhas Grava√ß√µes" id="userRecordings"></optgroup>
            </select>
            <button class="icon-btn" style="width:40px; height:36px; border-radius:6px; background:rgba(255,50,50,0.2)" onclick="DialogSys.confirmDelete()" title="Apagar selecionado">üóë</button>
        </div>

        <div class="controls-wrapper">
            <div class="controls-grid">
                <button id="btnPlay" class="btn-play" onclick="GameSys.togglePlay()" disabled>
                    <span class="btn-icon">‚ñ∂</span> <span class="btn-label">Tocar</span>
                </button>
                <button id="btnRec" class="btn-rec" onclick="GameSys.handleRecordButton()">
                    <span class="btn-icon">üéπ</span> <span class="btn-label">Rec</span>
                </button>
                <button id="btnMetro" class="btn-metro" onclick="MetronomeSys.toggle()">
                    <span class="btn-icon">‚è±</span> <span class="btn-label">Ritmo</span>
                </button>
                <button class="btn-dj" onclick="UISys.openModal('djModal'); StudioSys.init()">
                    <span class="btn-icon">üéõ</span> <span class="btn-label">DJ Mixer</span>
                </button>
                <button id="btnPedal" class="btn-pedal" onclick="AudioSys.toggleSustain()">
                    <span class="btn-icon">‚óã</span> <span class="btn-label">Pedal</span>
                </button>
            </div>
        </div>
        
        <div style="display:flex; justify-content:center; gap:10px; margin-top:5px;">
             <button style="height:30px; width:100px; font-size:0.7rem" onclick="document.getElementById('fileInput').click()">üì• Importar</button>
             <button style="height:30px; width:100px; font-size:0.7rem" onclick="UISys.openModal('configModal')">‚öôÔ∏è Config</button>
             <button style="height:30px; width:100px; font-size:0.7rem; border-color:#555; background:#111" onclick="AudioSys.stopAll(true); GameSys.stop()">‚èπ Parar</button>
        </div>
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="SecuritySys.handleImport(this)">
    </div>

    <div class="visualizer-area">
        <canvas id="gameCanvas"></canvas>
        <div class="octave-ctrl">
            <div class="oct-btn" onclick="AudioSys.changeOctave(-1)">‚Äπ</div>
            <div class="oct-display" id="octaveDisplay">Padr√£o</div>
            <div class="oct-btn" onclick="AudioSys.changeOctave(1)">‚Ä∫</div>
        </div>
    </div>

    <div class="piano-container" id="pianoWrapper">
        <div class="keys-wrapper" id="keysContainer"></div>
    </div>

    <!-- DIALOG OVERLAY -->
    <div class="modal-overlay" id="customDialogOverlay">
        <div class="modal-box" style="text-align:center">
            <div class="modal-header"><span class="modal-title" id="dialogTitle">Aviso</span></div>
            <div class="modal-body">
                <p id="dialogMessage" style="color:#ccc; margin-bottom:20px; font-size:0.95rem;">Mensagem</p>
                <div id="dialogInputArea" style="display:none; margin-bottom:20px;"><input type="text" id="dialogInput" class="dialog-input" placeholder="Digite aqui..."></div>
                <div class="dialog-btns" id="dialogButtons"></div>
            </div>
        </div>
    </div>

    <!-- DJ MODAL -->
    <div class="modal-overlay" id="djModal">
        <div class="modal-box">
            <div class="modal-header"><span class="modal-title">üéõ DJ Studio</span><button class="icon-btn" onclick="UISys.closeModal('djModal')">‚úï</button></div>
            <div class="modal-body">
                <div class="sequencer-panel">
                    <div class="sequencer-title">Mixagem e Renderiza√ß√£o</div>
                    <div class="sequencer-actions">
                        <button class="btn-preview" onclick="StudioSys.previewSequence()"><span>‚ñ∂</span> PREVIEW (OUVIR)</button>
                        <button class="btn-render" onclick="StudioSys.renderAndSave()"><span>üíæ</span> BAIXAR √ÅUDIO</button>
                    </div>
                </div>
                <div class="dj-grid" id="studioDecks"></div>
                <button class="btn-add-deck" onclick="StudioSys.addDeck()"><span>+</span> Adicionar Deck</button>
            </div>
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div class="modal-overlay" id="configModal">
        <div class="modal-box" style="max-width:350px">
            <div class="modal-header"><span class="modal-title">‚öôÔ∏è Configura√ß√µes</span><button class="icon-btn" onclick="UISys.closeModal('configModal')">‚úï</button></div>
            <div class="modal-body">
                <div style="margin-bottom:15px"><label>Volume</label><input type="range" style="width:100%;" min="0" max="1" step="0.1" value="0.7" oninput="AudioSys.setVolume(this.value)"></div>
                <div style="margin-bottom:15px"><label>Metr√¥nomo</label><input type="range" style="width:100%" min="60" max="180" value="120" oninput="MetronomeSys.setBpm(this.value)"></div>
                <div style="margin-bottom:15px"><label>Timbre (Mude aqui para Overdub)</label><select onchange="AudioSys.setWaveform(this.value)" style="width:100%; background:#222; color:white; height:30px;"><option value="triangle">Grand Piano</option><option value="sine">Teclado Suave</option><option value="square">8-Bit Retro</option><option value="sawtooth">Sintetizador</option></select></div>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-box">
            <div class="modal-header"><span class="modal-title">‚ùì Manual</span><button class="icon-btn" onclick="UISys.closeModal('helpModal')">‚úï</button></div>
            <div class="modal-body">
                <div class="help-section">
                    <h4>üéπ Grava√ß√£o e Edi√ß√£o (Overdub)</h4>
                    <p>1. Selecione uma m√∫sica para gravar por cima dela. Se n√£o selecionar, grava do zero.</p>
                    <p>2. Mude o <b>Timbre</b> nas Configura√ß√µes antes de come√ßar a gravar para adicionar novos sons.</p>
                    <p>3. Toque novas notas. O sistema mistura o som antigo com o novo.</p>
                </div>
                <div class="help-section">
                    <h4>üéõ DJ Studio</h4>
                    <p>Carregue MP3s ou Grava√ß√µes. O "Preview" toca a m√∫sica com qualidade total, usando os timbres gravados.</p>
                </div>
                <div class="help-section">
                    <h4>‚å®Ô∏è Teclado PC</h4>
                    <ul>
                        <li>Brancas: Z at√© M (Graves) | Q at√© Y (Agudos)</li>
                        <li>Pretas: S, D, G, H, J | 2, 3, 5, 6, 7</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function startApp() {
            AudioSys.init();
            document.getElementById('splashScreen').style.opacity = '0';
            setTimeout(() => document.getElementById('splashScreen').remove(), 500);
        }

        const Toast = {
            timer: null,
            show(msg, type='') {
                const c = document.getElementById('toastContainer');
                while(c.firstChild) c.removeChild(c.firstChild); 
                const t = document.createElement('div'); t.className = 'toast';
                if(type==='error') t.style.borderLeftColor='#ff0055'; if(type==='success') t.style.borderLeftColor='#00ff88';
                t.innerText = msg; c.appendChild(t);
                if(this.timer) clearTimeout(this.timer); this.timer = setTimeout(()=> { if(t.parentNode) t.remove(); }, 2500);
            }
        };

        const DialogSys = {
            overlay: document.getElementById('customDialogOverlay'), title: document.getElementById('dialogTitle'), msg: document.getElementById('dialogMessage'), inputArea: document.getElementById('dialogInputArea'), input: document.getElementById('dialogInput'), btns: document.getElementById('dialogButtons'),
            show(title, message, buttons, inputMode = false) { this.title.innerText = title; this.msg.innerText = message; this.inputArea.style.display = inputMode ? 'block' : 'none'; if(inputMode) this.input.value = ''; this.btns.innerHTML = ''; buttons.forEach(btn => { const b = document.createElement('button'); b.className = `btn-dialog ${btn.class || 'btn-confirm'}`; b.innerText = btn.text; b.onclick = () => { this.close(); if(btn.action) btn.action(inputMode ? this.input.value : null); }; this.btns.appendChild(b); }); this.overlay.classList.add('open'); if(inputMode) this.input.focus(); },
            close() { this.overlay.classList.remove('open'); },
            promptName(callback) { this.show("Salvar", "Nome da m√∫sica:", [{text:"Cancelar",class:"btn-cancel"},{text:"Salvar",action:callback}], true); },
            confirmDelete() { const sel = document.getElementById('songSelect'); if(!sel.value) return Toast.show("Nada selecionado",'error'); this.show("Apagar", `Apagar "${sel.value.split(':')[1]}"?`, [{text:"N√£o",class:"btn-cancel"},{text:"Sim",class:"btn-danger",action:()=>UISys.doDelete(sel.value.split(':')[1])}]); }
        };

        const AudioSys = {
            ctx: null, masterGain: null, reverb: null, sustain: false, active: {}, wave: 'triangle', octaveOffset: 0, analyser: null,
            init() { 
                if(this.ctx) return; 
                const AC = window.AudioContext||window.webkitAudioContext; 
                this.ctx = new AC(); 
                this.masterGain = this.ctx.createGain(); 
                this.masterGain.gain.value = 0.7; 
                const comp = this.ctx.createDynamicsCompressor(); 
                this.analyser = this.ctx.createAnalyser(); 
                this.analyser.fftSize = 256;
                this.reverb = this.ctx.createConvolver(); 
                this.genReverb(); 
                this.masterGain.connect(comp); 
                comp.connect(this.analyser); 
                this.analyser.connect(this.ctx.destination); 
            },
            genReverb() { const len=this.ctx.sampleRate*2, buf=this.ctx.createBuffer(2,len,this.ctx.sampleRate); for(let i=0;i<len;i++){let d=(1-i/len); buf.getChannelData(0)[i]=(Math.random()*2-1)*d*d; buf.getChannelData(1)[i]=(Math.random()*2-1)*d*d;} this.reverb.buffer=buf; this.reverb.connect(this.masterGain); },
            freq(note, octOverride=null) { const notes={'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11}; let oct=parseInt(note.slice(-1))+(octOverride!==null?octOverride:this.octaveOffset); return 440*Math.pow(2,((oct-4)*12+(notes[note.slice(0,-1)]-9))/12); },
            play(n, vol=1, dest=null) { if(!this.ctx) this.init(); if(this.ctx.state==='suspended') this.ctx.resume(); if(this.active[n] && !dest) this.stop(n, true); const t=this.ctx.currentTime, osc=this.ctx.createOscillator(), g=this.ctx.createGain(); osc.type=this.wave; osc.frequency.value=this.freq(n); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol*0.4,t+0.01); g.gain.exponentialRampToValueAtTime(0.01,t+2.5); osc.connect(g); if(dest) g.connect(dest); else { const r=this.ctx.createGain(); r.gain.value=0.3; g.connect(r); r.connect(this.reverb); g.connect(this.masterGain); this.active[n]={o:osc,g:g}; } osc.start(t); if(dest) osc.stop(t+3); },
            scheduleNote(n, time, dur, gainNode, waveType, octOffset) {
                const osc=this.ctx.createOscillator(), env=this.ctx.createGain();
                osc.type = waveType || this.wave;
                osc.frequency.value = this.freq(n, octOffset);
                env.gain.setValueAtTime(0, time); env.gain.linearRampToValueAtTime(0.4, time+0.02); env.gain.setValueAtTime(0.4, time+dur-0.05); env.gain.linearRampToValueAtTime(0, time+dur);
                osc.connect(env); env.connect(gainNode); osc.start(time); osc.stop(time+dur+0.1);
            },
            stop(n, force=false) { if(!this.active[n]) return; if(this.sustain && !force) return; try{ this.active[n].g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+2.0); this.active[n].o.stop(this.ctx.currentTime+2.1); }catch(e){} delete this.active[n]; },
            stopAll(kill=false) { if(!this.ctx) return; Object.keys(this.active).forEach(k=>{try{this.active[k].o.stop()}catch(e){}}); this.active={}; if(kill){ if(window.StudioSys) StudioSys.stopAllDecks(); document.querySelectorAll('.key.active').forEach(k=>k.classList.remove('active'));} },
            changeOctave(d) { this.octaveOffset+=d; if(this.octaveOffset>2) this.octaveOffset=2; if(this.octaveOffset<-2) this.octaveOffset=-2; const lbl={'-2':'Sub','-1':'Grave',0:'Padr√£o',1:'Agudo',2:'Cristal'}; document.getElementById('octaveDisplay').innerText=lbl[this.octaveOffset]; },
            toggleSustain() { this.sustain=!this.sustain; document.getElementById('btnPedal').classList.toggle('active'); if(!this.sustain) Object.keys(this.active).forEach(n=>this.stop(n)); },
            setVolume(v) { if(this.masterGain) this.masterGain.gain.value=v; }, setWaveform(w) { this.wave=w; }
        };

        const GameSys = {
            playing: false, recording: false, recData: [], recStart: 0, activeRecs: {},
            handleRecordButton() {
                if(this.recording) this.stopRecording();
                else {
                    const sel = document.getElementById('songSelect').value;
                    this.startRecording(!!sel, sel ? sel.split(':')[1] : null);
                }
            },
            startRecording(isOverdub, songName) {
                AudioSys.stopAll(); this.recording=true; this.recStart=performance.now(); document.getElementById('btnRec').classList.add('active');
                if(isOverdub && songName) {
                    const oldData = JSON.parse(JSON.stringify(UISys.songs[songName]));
                    this.recData = oldData; 
                    const now = AudioSys.ctx.currentTime;
                    oldData.forEach(note => AudioSys.scheduleNote(note.n, now + note.t, note.d, AudioSys.masterGain, note.w, note.o));
                    Toast.show("GRAVANDO (OVERDUB)...", 'success');
                } else {
                    this.recData = []; Toast.show("GRAVANDO...", 'success');
                }
            },
            stopRecording() {
                this.recording=false; document.getElementById('btnRec').classList.remove('active'); AudioSys.stopAll(false);
                if(this.recData.length>0) DialogSys.promptName(n=>{if(n){UISys.save(n, this.recData); Toast.show("Salvo!");}});
            },
            recInput(n, type) {
                if(!this.recording) return; const t=(performance.now()-this.recStart)/1000;
                if(type==='on') this.activeRecs[n]=t;
                else if(this.activeRecs[n]!==undefined) {
                    this.recData.push({n, t:this.activeRecs[n], d:Math.max(0.1,t-this.activeRecs[n]), w:AudioSys.wave, o:AudioSys.octaveOffset});
                    delete this.activeRecs[n];
                }
            },
            togglePlay() {
                if(this.playing) return this.stop();
                const v = document.getElementById('songSelect').value; if(!v) return;
                this.playing = true; document.getElementById('btnPlay').classList.add('active');
                const data = JSON.parse(JSON.stringify(UISys.songs[v.split(':')[1]])).sort((a,b)=>a.t-b.t);
                const start = performance.now();
                const now = AudioSys.ctx.currentTime;
                data.forEach(note => AudioSys.scheduleNote(note.n, now + note.t, note.d, AudioSys.masterGain, note.w, note.o));
                const loop = () => {
                    if(!this.playing) return;
                    const elapsed = (performance.now()-start)/1000;
                    data.forEach(n => {
                        if(!n.played && n.t <= elapsed) {
                            n.played=true; const k=document.querySelector(`.key[data-note="${n.n}"]`);
                            if(k){k.classList.add('active'); setTimeout(()=>k.classList.remove('active'),n.d*1000);}
                        }
                    });
                    if(elapsed > data[data.length-1].t+2) this.stop(); else requestAnimationFrame(loop);
                };
                loop();
            },
            stop() { this.playing=false; document.getElementById('btnPlay').classList.remove('active'); AudioSys.stopAll(false); }
        };

        const StudioSys = {
            initialized: false, decks: [], deckCounter: 0,
            init() { if(this.initialized) return; this.addDeck(); this.addDeck(); this.initialized=true; },
            addDeck() {
                const uid=this.deckCounter++, c=document.getElementById('studioDecks'), d=document.createElement('div'); d.className='deck'; d.id=`deck-${uid}`;
                const opts = Object.keys(UISys.songs).map(k=>`<option value="${k}">${k}</option>`).join('');
                d.innerHTML = `<button class="btn-close-deck" onclick="StudioSys.removeDeck(${uid})">‚úï</button><div class="deck-top"><div class="vinyl" id="vinyl${uid}"></div><div style="flex:1"><div style="font-weight:bold;font-size:0.8rem;color:#aaa;margin-bottom:5px">DECK ${uid+1}</div><div style="display:flex;gap:5px;margin-bottom:5px"><select id="deckSel${uid}" style="width:100%;font-size:0.8rem">${opts||'<option value="">(Vazio)</option>'}</select><button onclick="document.getElementById('mp3${uid}').click()" style="width:40px;background:#333;border:1px solid #555;border-radius:4px">üìÇ</button></div><input type="file" id="mp3${uid}" style="display:none" onchange="StudioSys.loadMP3(${uid},this)"><div id="mp3Name${uid}" style="font-size:0.7rem;color:var(--accent);display:none"></div></div></div><div class="eq-grid"><div class="eq-col"><label style="font-size:0.6rem;color:#aaa">HIGH</label><div class="slider-wrapper"><input type="range" class="slider-v" min="-20" max="20" value="0" oninput="StudioSys.setEQ(${uid},'high',this.value)"></div></div><div class="eq-col"><label style="font-size:0.6rem;color:#aaa">MID</label><div class="slider-wrapper"><input type="range" class="slider-v" min="-20" max="20" value="0" oninput="StudioSys.setEQ(${uid},'mid',this.value)"></div></div><div class="eq-col"><label style="font-size:0.6rem;color:#aaa">LOW</label><div class="slider-wrapper"><input type="range" class="slider-v" min="-20" max="20" value="0" oninput="StudioSys.setEQ(${uid},'low',this.value)"></div></div></div><div class="slider-group"><label>SPEED</label><input type="range" min="0.5" max="1.5" step="0.01" value="1" oninput="StudioSys.setParam(${uid},'speed',this.value)"></div><div class="slider-group"><label>VOLUME</label><input type="range" id="vol${uid}" min="0" max="1.2" step="0.05" value="1" oninput="StudioSys.setParam(${uid},'vol',this.value)"></div>`;
                c.appendChild(d);
                if(!AudioSys.ctx) AudioSys.init(); const ctx=AudioSys.ctx;
                const eqH=ctx.createBiquadFilter(), eqM=ctx.createBiquadFilter(), eqL=ctx.createBiquadFilter(), g=ctx.createGain();
                eqH.type="highshelf"; eqH.frequency.value=3000; eqM.type="peaking"; eqM.frequency.value=1000; eqL.type="lowshelf"; eqL.frequency.value=320;
                eqH.connect(eqM); eqM.connect(eqL); eqL.connect(g); g.connect(AudioSys.masterGain);
                this.decks.push({uiId:uid, active:false, speed:1, vol:1, mode:'piano', audioBuffer:null, duration:0, nodes:{h:eqH,m:eqM,l:eqL,g:g}});
            },
            removeDeck(uid) { const idx=this.decks.findIndex(d=>d.uiId===uid); if(idx>-1){try{this.decks[idx].nodes.g.disconnect()}catch(e){} this.decks.splice(idx,1); document.getElementById(`deck-${uid}`).remove();} },
            loadMP3(uid, inp) { const d=this.decks.find(x=>x.uiId===uid), f=inp.files[0]; if(!d||!f)return; const r=new FileReader(); Toast.show("Carregando..."); r.onload=e=>{AudioSys.ctx.decodeAudioData(e.target.result, b=>{d.audioBuffer=b; d.mode='mp3'; d.duration=b.duration; document.getElementById(`deckSel${uid}`).style.display='none'; document.getElementById(`mp3Name${uid}`).style.display='block'; document.getElementById(`mp3Name${uid}`).innerText="üéµ "+f.name; Toast.show("Pronto!");})}; r.readAsArrayBuffer(f); },
            setParam(uid,p,v){const d=this.decks.find(x=>x.uiId===uid); if(d){d[p]=parseFloat(v); if(p==='vol')d.nodes.g.gain.value=d[p];}},
            setEQ(uid,b,v){const d=this.decks.find(x=>x.uiId===uid); if(d){if(b==='high')d.nodes.h.gain.value=v; if(b==='mid')d.nodes.m.gain.value=v; if(b==='low')d.nodes.l.gain.value=v;}},
            previewSequence() { if(!AudioSys.ctx) AudioSys.init(); this.stopAllDecks(); Toast.show("‚ñ∂ Preview...",'success'); this.run(false); },
            renderAndSave() { if(!AudioSys.ctx) AudioSys.init(); this.stopAllDecks(); DialogSys.promptName(n=>{if(n){const dest=AudioSys.ctx.createMediaStreamDestination(); AudioSys.masterGain.connect(dest); const rec=new MediaRecorder(dest.stream), ch=[]; rec.ondataavailable=e=>ch.push(e.data); rec.onstop=()=>{const b=new Blob(ch,{type:'audio/webm'}), u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download=n+'.webm'; a.click(); Toast.show("Baixado!",'success');}; rec.start(); Toast.show("üî¥ Renderizando..."); this.run(true, rec);}}); },
            run(rec, recorder) {
                const now=AudioSys.ctx.currentTime+0.2; let cumTime=0;
                this.decks.forEach(d=>{
                    let dur=0;
                    setTimeout(()=>{const el=document.getElementById(`deck-${d.uiId}`); if(el){el.classList.add('playing'); el.scrollIntoView({behavior:'smooth',block:'center'});} const v=document.getElementById(`vinyl${d.uiId}`); if(v)v.classList.add('spinning');}, cumTime*1000);
                    if(d.mode==='mp3'&&d.audioBuffer){ dur=d.duration/d.speed; const s=AudioSys.ctx.createBufferSource(); s.buffer=d.audioBuffer; s.playbackRate.value=d.speed; s.connect(d.nodes.h); s.start(now+cumTime); }
                    else {
                        const sel=document.getElementById(`deckSel${d.uiId}`);
                        if(sel && sel.value && UISys.songs[sel.value]){
                            const data=UISys.songs[sel.value]; dur=(data[data.length-1].t+2)/d.speed;
                            data.forEach(n=>AudioSys.scheduleNote(n.n, now+cumTime+(n.t/d.speed), n.d/d.speed, d.nodes.h, n.w, n.o));
                        }
                    }
                    if(dur>0){ setTimeout(()=>{const el=document.getElementById(`deck-${d.uiId}`); if(el)el.classList.remove('playing'); const v=document.getElementById(`vinyl${d.uiId}`); if(v)v.classList.remove('spinning');}, (cumTime+dur)*1000); cumTime+=dur-0.5; }
                });
                if(rec && recorder) setTimeout(()=>recorder.stop(), (cumTime+1)*1000);
            },
            stopAllDecks() { this.decks.forEach(d=>{const e=document.getElementById(`deck-${d.uiId}`),v=document.getElementById(`vinyl${d.uiId}`); if(e)e.classList.remove('playing');if(v)v.classList.remove('spinning');}); }
        };

        const UISys = {
            songs: {}, init(){this.songs=JSON.parse(localStorage.getItem('vp_songs')||'{}'); this.refresh(); this.buildKeys(); this.bindPCKeys();},
            buildKeys(){const c=document.getElementById('keysContainer'), pc=['Z','X','C','V','B','N','M',',','.','Q','W','E','R','T','Y']; for(let i=0;i<15;i++){const o=3+Math.floor(i/7), n=['C','D','E','F','G','A','B'][i%7]; if(o>5||(o===5&&n!=='C'))break; const k=document.createElement('div'); k.className='key white'; k.dataset.note=n+o; k.innerHTML=`<span class="key-label">${pc[i]||''}</span>`; c.appendChild(k); if(['C','D','F','G','A'].includes(n)&&!(o===5&&n==='C')){const b=document.createElement('div'); b.className='key black'; b.dataset.note=n+'#'+o; b.style.left=`calc(${(i+1)*(100/15)-3.5}% - 1px)`; c.appendChild(b);}}},
            bindPCKeys() {
                const map = {'z':'C3','x':'D3','c':'E3','v':'F3','b':'G3','n':'A3','m':'B3',',':'C4','.':'D4','s':'C#3','d':'D#3','g':'F#3','h':'G#3','j':'A#3','l':'C#4',';':'D#4','q':'C4','w':'D4','e':'E4','r':'F4','t':'G4','y':'A4','u':'B4','i':'C5','2':'C#4','3':'D#4','5':'F#4','6':'G#4','7':'A#4'};
                window.addEventListener('keydown', e => { if(e.repeat || e.target.tagName==='INPUT') return; const n = map[e.key.toLowerCase()]; if(n) { const el = document.querySelector(`.key[data-note="${n}"]`); if(el) { el.classList.add('active'); AudioSys.play(n); GameSys.recInput(n, 'on'); } } });
                window.addEventListener('keyup', e => { const n = map[e.key.toLowerCase()]; if(n) { const el = document.querySelector(`.key[data-note="${n}"]`); if(el) { el.classList.remove('active'); AudioSys.stop(n); GameSys.recInput(n, 'off'); } } });
            },
            refresh(){const g=document.getElementById('userRecordings'); g.innerHTML=''; Object.keys(this.songs).forEach(k=>{const o=document.createElement('option'); o.value='usr:'+k; o.text=k; g.appendChild(o);}); this.checkButtons(); StudioSys.decks.forEach(d=>{if(d.mode==='piano'){const s=document.getElementById(`deckSel${d.uiId}`), v=s?s.value:''; if(s){s.innerHTML=Object.keys(this.songs).map(k=>`<option value="${k}">${k}</option>`).join('')||'<option value="">(Vazio)</option>'; s.value=v;}}});},
            save(n,d){this.songs[n]=d; localStorage.setItem('vp_songs',JSON.stringify(this.songs)); this.refresh();},
            doDelete(n){delete this.songs[n]; localStorage.setItem('vp_songs',JSON.stringify(this.songs)); this.refresh(); Toast.show("Apagado!",'success');},
            checkButtons(){document.getElementById('btnPlay').disabled=!document.getElementById('songSelect').value;},
            openModal(id){document.getElementById(id).classList.add('open');}, closeModal(id){document.getElementById(id).classList.remove('open');},
            exportSong() { const f = document.getElementById('fileInput'); if(f) f.click(); }
        };

        const SecuritySys = { handleImport(inp){const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{try{const d=JSON.parse(e.target.result); if(Array.isArray(d)) DialogSys.promptName(n=>{if(n){UISys.save(n,d);Toast.show("Importado!",'success');}});}catch(e){Toast.show("Erro",'error');} inp.value='';}; r.readAsText(f);} };
        const MetronomeSys = { active:false, bpm:120, timer:null, toggle(){this.active=!this.active; document.getElementById('btnMetro').classList.toggle('active'); if(this.active){this.loop();Toast.show("Metr√¥nomo ON");}else{clearTimeout(this.timer);Toast.show("OFF");}}, loop(){if(!this.active)return; this.beep(); this.timer=setTimeout(()=>this.loop(),60000/this.bpm);}, beep(){if(!AudioSys.ctx)AudioSys.init(); const o=AudioSys.ctx.createOscillator(),g=AudioSys.ctx.createGain(); o.freq=1000; g.gain.value=0.1; o.connect(g); g.connect(AudioSys.ctx.destination); o.start(); o.stop(AudioSys.ctx.currentTime+0.05);}, setBpm(v){this.bpm=v;} };

        const VisualSys = {
            init() { this.c = document.getElementById('gameCanvas'); this.ctx = this.c.getContext('2d'); window.addEventListener('resize', ()=>this.res()); this.res(); this.loop(); },
            res() { this.c.width = this.c.offsetWidth; this.c.height = this.c.offsetHeight; },
            loop() { 
                requestAnimationFrame(()=>this.loop()); 
                this.ctx.clearRect(0,0,this.c.width,this.c.height); 
                if(!AudioSys.analyser) return; 
                const buf = new Uint8Array(AudioSys.analyser.frequencyBinCount); 
                AudioSys.analyser.getByteFrequencyData(buf); 
                const w = this.c.width / 50; 
                for(let i=0; i<50; i++) { 
                    const h = (buf[i*2] / 255) * this.c.height; 
                    this.ctx.fillStyle = `hsl(${i*5}, 100%, 50%)`; 
                    this.ctx.fillRect(i*w, this.c.height-h, w-1, h); 
                } 
            } 
        };

        (function() {
            UISys.init(); VisualSys.init(); 
            // AudioSys.init() √© chamado apenas no bot√£o "Come√ßar"
            const w=document.getElementById('pianoWrapper'), ptrs=new Map();
            const noteOn=(e,el)=>{const n=el.dataset.note; if(ptrs.get(e.pointerId)===n)return; if(ptrs.has(e.pointerId))noteOff(e.pointerId,true); ptrs.set(e.pointerId,n); el.classList.add('active'); AudioSys.play(n); GameSys.recInput(n,'on');};
            const noteOff=(pid,s)=>{if(ptrs.has(pid)){const n=ptrs.get(pid); AudioSys.stop(n); GameSys.recInput(n,'off'); const el=document.querySelector(`.key[data-note="${n}"]`); if(el)el.classList.remove('active'); if(!s)ptrs.delete(pid);}};
            w.addEventListener('pointerdown',e=>{e.preventDefault(); w.setPointerCapture(e.pointerId); const el=document.elementFromPoint(e.clientX,e.clientY); if(el&&el.classList.contains('key'))noteOn(e,el);});
            w.addEventListener('pointermove',e=>{e.preventDefault(); if(ptrs.has(e.pointerId)){const el=document.elementFromPoint(e.clientX,e.clientY); if(el&&el.classList.contains('key'))noteOn(e,el); else{noteOff(e.pointerId); ptrs.delete(e.pointerId);}}});
            w.addEventListener('pointerup',e=>{e.preventDefault(); noteOff(e.pointerId); w.releasePointerCapture(e.pointerId);});
            w.addEventListener('pointercancel',e=>noteOff(e.pointerId));
        })();
    </script>
</body>
</html>